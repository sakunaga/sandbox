#!/bin/bash

function error() {
    echo -e "$1"
    usage
    exit 1
}

function mg_init() {
    echo -e "\033[1;32msandbox init\033[0;39m ã‚’å®Ÿè¡Œã—ã¦åˆæœŸè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
}

function mg_reset() {
    echo -e "\033[1;32msandbox reset\033[0;39m ã‚’å®Ÿè¡Œã—ã¦è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
}

function er_init() {
    read -p "åˆæœŸè¨­å®šã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ [Y/n]: " answer
    case $answer in
        "" | "Y" | "y" | "yes" | "Yes" | "YES" ) ;;
        * ) mg_init;;
    esac
    init
    exit 1
}

function usage() {
    echo -e "ä½¿ç”¨æ–¹æ³•:"
    echo -e "    \033[1;32msandbox\033[0;39m            ... ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã (çœç•¥å½¢)"
    echo -e "    \033[1;32msandbox init\033[0;39m       ... åˆæœŸè¨­å®š"
    echo -e "    \033[1;32msandbox update\033[0;39m     ... è¨­å®šã‚’æ›´æ–°ã™ã‚‹"
    echo -e "    \033[1;32msandbox open\033[0;39m       ... ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã"
    echo -e "    \033[1;32msandbox info\033[0;39m       ... è¨­å®šæƒ…å ±ã‚’ç¢ºèªã™ã‚‹"
    echo -e "    \033[1;32msandbox reset\033[0;39m      ... è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹"
    echo -e "    \033[1;32msandbox upgrade\033[0;39m    ... æœ¬ä½“ã‚’æ›´æ–°ã™ã‚‹"
    echo -e "    \033[1;32msandbox uninstall\033[0;39m  ... æœ¬ä½“ã‚’å‰Šé™¤ã™ã‚‹"
}

function info() {
    if [ ! -e ./sandbox.conf ]; then
        mg_init; er_init;
    fi

    source ./sandbox.conf

    if [ -n "$created" ]; then
        echo -e "ä½œæˆæ™‚é–“: \033[1;32m$created\033[0;39m"
    fi
    if [ -n "$updated" ]; then
        echo -e "æœ€çµ‚æ›´æ–°æ™‚é–“: \033[1;32m$updated\033[0;39m"
    fi
    echo -e "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: \033[1;32m$dir\033[0;39m"
}


function init() {
    if [ -e ./sandbox.conf ]; then
        mg_reset
        exit 1
    fi
    read -p "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: " dir
    expanded_dir="${dir/#\~/$HOME}"
    if [ ! -e "$expanded_dir" ]; then
        mkdir -p "$expanded_dir"
        echo -e "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€Œ\033[1;32m$dir\033[0;39mã€ ã‚’ä½œæˆã—ã¾ã—ãŸã€‚"
    else
        echo -e "\033[1;32m$dir\033[0;39m ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚"
    fi
    echo "created='$(date)'" > ./sandbox.conf
    echo "dir='${dir}'" >> ./sandbox.conf
    echo -e "\033[1;34måˆæœŸè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚\033[0;39m"
}

function update() {
    if [ ! -e ./sandbox.conf ]; then
        mg_init; er_init;
    fi

    read -p "è¨­å®šã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ [Y/n]: " answer
    case $answer in
        "" | "Y" | "y" | "yes" | "Yes" | "YES" ) ;;
        * ) exit 1;;
    esac

    # æ—¢å­˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    source ./sandbox.conf

    echo -e "ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: \033[1;32m$dir\033[0;39m"
    read -p "æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: " dir
    expanded_dir="${dir/#\~/$HOME}"

    if [ ! -e "$expanded_dir" ]; then
        mkdir -p "$expanded_dir"
        echo -e "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€Œ\033[1;32m'$dir'\033[0;39m ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚"
    else
        echo -e "\033[1;32m$dir\033[0;39m ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚"
    fi

    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°ã€‚createdã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ä¿æŒã—ã¤ã¤ã€dirã¨updatedã‚’ä¸Šæ›¸ã
    if [ -n "$created" ]; then
        echo "created='${created}'" > ./sandbox.conf
    fi
    echo "updated='$(date)'" >> ./sandbox.conf
    echo "dir='${dir}'" >> ./sandbox.conf

    echo -e "\033[1;34mè¨­å®šã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\033[0;39m"
}





function open() {
    if [ ! -e ./sandbox.conf ]; then
        mg_init; er_init;
    fi
    source ./sandbox.conf
    expanded_dir="${dir/#\~/$HOME}"
    cd "$expanded_dir"
    
    folders=($(find . -maxdepth 1 -type d | sort | sed '1d; s|^\./||'))


    if [ ${#folders[@]} -eq 0 ]; then
        error "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚"
    fi


    echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„: "
    for i in "${!folders[@]}"; do
        echo " $((i+1))) ${folders[i]}"
    done


    read -p "ç•ªå·ã‚’å…¥åŠ›: " choice


    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#folders[@]}" ]; then
        selected_folder="${folders[$((choice-1))]}"
        
        code "$selected_folder"
        echo -e "\033[1;32mãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ $selected_folder ã‚’VSCodeã§é–‹ãã¾ã—ãŸã€‚\033[0;39m"
    else
        error "ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚"
    fi
}

function reset() {
    if [ ! -e ./sandbox.conf ]; then
        mg_init; er_init;
    fi
    read -p "è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ [Y/n]: " answer
    case $answer in
        "" | "Y" | "y" | "yes" | "Yes" | "YES" ) ;;
        * ) exit 1;;
    esac
    rm -f ./sandbox.conf
    echo -e "\033[1;34mãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\033[0;39m"
}

function upgrade() {
    echo -e "ğŸº \033[1;32mbrew upgrade sandbox\033[0;39m ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚"
    brew upgrade sandbox
    echo -e "ğŸº \033[1;32mbrew upgrade sandbox\033[0;39m ã®å®Ÿè¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸã€‚"
}

function uninstall() {
    read -p "æœ¬ä½“ã‚’Homebrewã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã‹ï¼Ÿ [Y/n]: " answer01
    case $answer01 in
        "" | "Y" | "y" | "yes" | "Yes" | "YES" ) ;;
        * ) exit 1;;
    esac
    read -p "untapã—ã¾ã™ã‹ï¼Ÿ [Y/n]: " answer02
    case $answer02 in
        "" | "Y" | "y" | "yes" | "Yes" | "YES" ) ;;
        * ) rm -f ./sandbox.conf; brew uninstall sandbox; echo -e "ğŸ‘‹ \033[1;34msandbox\033[0;39m ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"; exit 1;;
    esac
    rm -f ./sandbox.conf
    brew uninstall sandbox
    brew untap sakunaga/sandbox
    echo -e "ğŸ‘‹ \033[1;34msandbox\033[0;39m ã®ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼"
}

cd `dirname $0`
case $1 in
    -h ) usage ;;
    info ) info ;;
    init ) init ;;
    update ) update ;;
    open ) open ;;
    reset ) reset ;;
    upgrade ) upgrade ;;
    uninstall ) uninstall ;;
    * ) open ;;
esac
